from fastapi import FastAPI, HTTPException
from fastapi.responses import HTMLResponse
from pydantic import BaseModel, Field
from typing import List, Optional
from datetime import date
import sqlite3
import uuid
import os
from openai import OpenAI

# –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è FastAPI
app = FastAPI(
    title="JDG Accounting Pro",
    description="–ü—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∞ –±—É—Ö–≥–∞–ª—Ç–µ—Ä—Å—å–∫–∞ —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –ø–æ–ª—å—Å—å–∫–∏—Ö –ø—ñ–¥–ø—Ä–∏—î–º—Ü—ñ–≤",
    version="2.0.0"
)

# ---------- Database Setup ----------
def init_db():
    conn = sqlite3.connect('accounting.db')
    cursor = conn.cursor()
    
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS transactions (
            id TEXT PRIMARY KEY,
            date TEXT NOT NULL,
            type TEXT NOT NULL,
            category TEXT,
            amount REAL NOT NULL,
            description TEXT,
            created_at TEXT DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS tax_calculations (
            id TEXT PRIMARY KEY,
            year INTEGER NOT NULL,
            gross_income REAL NOT NULL,
            expenses REAL NOT NULL,
            tax_mode TEXT NOT NULL,
            tax_result REAL NOT NULL,
            created_at TEXT DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS business_stats (
            id TEXT PRIMARY KEY,
            month TEXT NOT NULL,
            income REAL DEFAULT 0,
            expenses REAL DEFAULT 0,
            profit REAL DEFAULT 0,
            created_at TEXT DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    conn.commit()
    conn.close()

init_db()

# ---------- Models ----------
class Transaction(BaseModel):
    id: Optional[str] = None
    date: date
    type: str = Field(..., pattern="^(income|expense)$")
    category: str = "other"
    amount: float = Field(..., gt=0)
    description: str = ""

class TaxRequest(BaseModel):
    year: int = Field(..., ge=2020, le=2030)
    gross_income: float = Field(..., ge=0)
    expenses: float = Field(0.0, ge=0)
    tax_mode: str = Field(..., pattern="^(progressive|flat19|lump_sum)$")

class ChatRequest(BaseModel):
    message: str = Field(..., min_length=1)

# ---------- HTML Template ----------
def get_base_html(title: str, content: str) -> str:
    return f"""
<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{title}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {{
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }}
        
        body {{
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }}
        
        .container {{
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }}
        
        header {{
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
        }}
        
        h1 {{
            color: #4a5568;
            font-size: 2.8em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
        }}
        
        .subtitle {{
            color: #718096;
            font-size: 1.3em;
            margin-bottom: 20px;
            font-weight: 300;
        }}
        
        .nav {{
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 25px 0;
            flex-wrap: wrap;
        }}
        
        .dashboard {{
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
            margin-bottom: 35px;
        }}
        
        .card {{
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(10px);
        }}
        
        .card:hover {{
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }}
        
        .card h3 {{
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.5em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }}
        
        .btn {{
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }}
        
        .btn:hover {{
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }}
        
        .btn-secondary {{
            background: linear-gradient(135deg, #718096 0%, #4a5568 100%);
        }}
        
        .btn-success {{
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }}
        
        .btn-danger {{
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        }}
        
        .form-group {{
            margin-bottom: 25px;
        }}
        
        label {{
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }}
        
        input, select, textarea {{
            width: 100%;
            padding: 14px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.8);
        }}
        
        input:focus, select:focus, textarea:focus {{
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: white;
        }}
        
        .transaction-list {{
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }}
        
        .transaction-item {{
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s ease;
        }}
        
        .transaction-item:hover {{
            background-color: #f7fafc;
        }}
        
        .transaction-income {{
            border-left: 6px solid #48bb78;
            background: linear-gradient(90deg, rgba(72, 187, 120, 0.05) 0%, transparent 100%);
        }}
        
        .transaction-expense {{
            border-left: 6px solid #f56565;
            background: linear-gradient(90deg, rgba(245, 101, 101, 0.05) 0%, transparent 100%);
        }}
        
        .feature-grid {{
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
        }}
        
        .feature {{
            background: rgba(255,255,255,0.9);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            transition: transform 0.3s ease;
            border: 1px solid rgba(255,255,255,0.2);
        }}
        
        .feature:hover {{
            transform: translateY(-5px);
        }}
        
        footer {{
            text-align: center;
            margin-top: 60px;
            color: white;
            opacity: 0.9;
            padding: 30px;
        }}
        
        .stats {{
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }}
        
        .stat-item {{
            background: rgba(255,255,255,0.95);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.3);
        }}
        
        .stat-number {{
            font-size: 2.5em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 10px;
        }}
        
        .result-card {{
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 35px;
            margin: 25px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(10px);
        }}
        
        .success {{
            color: #48bb78;
            font-weight: bold;
        }}
        
        .error {{
            color: #f56565;
            font-weight: bold;
        }}
        
        .warning {{
            color: #ed8936;
            font-weight: bold;
        }}
        
        .loading {{
            text-align: center;
            padding: 40px;
            color: #718096;
            font-size: 1.1em;
        }}
        
        .ai-response {{
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border-left: 4px solid #667eea;
        }}
        
        .finance-summary {{
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }}
        
        .summary-card {{
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }}
        
        .income-card {{
            border-top: 4px solid #48bb78;
        }}
        
        .expense-card {{
            border-top: 4px solid #f56565;
        }}
        
        .profit-card {{
            border-top: 4px solid #667eea;
        }}
        
        @media (max-width: 768px) {{
            .nav {{
                flex-direction: column;
                align-items: center;
            }}
            
            .btn {{
                width: 100%;
                justify-content: center;
            }}
            
            h1 {{
                font-size: 2.2em;
            }}
        }}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-chart-line"></i> JDG Accounting Pro</h1>
            <p class="subtitle">–ü—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∞ –±—É—Ö–≥–∞–ª—Ç–µ—Ä—ñ—è –¥–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –±—ñ–∑–Ω–µ—Å—É –≤ –ü–æ–ª—å—â—ñ</p>
            <div class="nav">
                <a href="/" class="btn"><i class="fas fa-home"></i> –ì–æ–ª–æ–≤–Ω–∞</a>
                <a href="/transactions" class="btn"><i class="fas fa-money-bill-wave"></i> –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó</a>
                <a href="/tax-calculator" class="btn"><i class="fas fa-calculator"></i> –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</a>
                <a href="/ai-chat" class="btn"><i class="fas fa-robot"></i> AI –ü–æ–º—ñ—á–Ω–∏–∫</a>
                <a href="/financial-summary" class="btn"><i class="fas fa-chart-bar"></i> –ó–≤—ñ—Ç–∏</a>
                <a href="/docs" class="btn btn-secondary" target="_blank"><i class="fas fa-book"></i> –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è</a>
            </div>
        </header>
        
        {content}
        
        <footer>
            <p>¬© 2024 JDG Accounting Pro | –í–µ—Ä—Å—ñ—è 2.0.0 | –†–æ–∑—Ä–æ–±–ª–µ–Ω–æ –∑ ‚ù§Ô∏è –¥–ª—è –ø–æ–ª—å—Å—å–∫–∏—Ö –ø—ñ–¥–ø—Ä–∏—î–º—Ü—ñ–≤</p>
        </footer>
    </div>
    
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ñ —É—Ç–∏–ª—ñ—Ç–∏
        function showLoading(elementId, message = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...') {{
            document.getElementById(elementId).innerHTML = `<div class="loading"><i class="fas fa-spinner fa-spin"></i> ${message}</div>`;
        }}
        
        function showError(elementId, message) {{
            document.getElementById(elementId).innerHTML = `<div class="error"><i class="fas fa-exclamation-triangle"></i> ${message}</div>`;
        }}
        
        function showSuccess(elementId, message) {{
            document.getElementById(elementId).innerHTML = `<div class="success"><i class="fas fa-check-circle"></i> ${message}</div>`;
        }}
        
        function formatCurrency(amount) {{
            return new Intl.NumberFormat('pl-PL', {{ style: 'currency', currency: 'PLN' }}).format(amount);
        }}
        
        function formatDate(dateString) {{
            return new Date(dateString).toLocaleDateString('uk-UA');
        }}
    </script>
</body>
</html>
"""

# ---------- Beautiful Pages ----------
@app.get("/", response_class=HTMLResponse)
def root():
    content = """
    <div class="stats">
        <div class="stat-item">
            <div class="stat-number"><i class="fas fa-rocket"></i> 2.0</div>
            <div>–í–µ—Ä—Å—ñ—è —Å–∏—Å—Ç–µ–º–∏</div>
        </div>
        <div class="stat-item">
            <div class="stat-number"><i class="fas fa-check-circle"></i> 100%</div>
            <div>–°—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å</div>
        </div>
        <div class="stat-item">
            <div class="stat-number"><i class="fas fa-bolt"></i> 0.1—Å</div>
            <div>–®–≤–∏–¥–∫—ñ—Å—Ç—å</div>
        </div>
    </div>
    
    <div class="dashboard">
        <div class="card">
            <h3><i class="fas fa-money-bill-wave"></i> –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ñ—ñ–Ω–∞–Ω—Å–∞–º–∏</h3>
            <p>–ü–æ–≤–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –¥–æ—Ö–æ–¥–∞–º–∏ —Ç–∞ –≤–∏—Ç—Ä–∞—Ç–∞–º–∏ –≤–∞—à–æ–≥–æ –±—ñ–∑–Ω–µ—Å—É. –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ.</p>
            <a href="/transactions" class="btn"><i class="fas fa-plus"></i> –î–æ–¥–∞—Ç–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é</a>
        </div>
        
        <div class="card">
            <h3><i class="fas fa-calculator"></i> –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –ø–æ–¥–∞—Ç–∫—ñ–≤</h3>
            <p>–¢–æ—á–Ω—ñ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫–∏ –¥–ª—è –≤—Å—ñ—Ö —Ñ–æ—Ä–º –æ–ø–æ–¥–∞—Ç–∫—É–≤–∞–Ω–Ω—è. –ü—Ä–æ–≥—Ä–µ—Å–∏–≤–Ω–∞, –ª—ñ–Ω—ñ–π–Ω–∞, —Ä–∏—Ü–∞≈Ç—Ç —Å–∏—Å—Ç–µ–º–∏.</p>
            <a href="/tax-calculator" class="btn"><i class="fas fa-calculator"></i> –†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏</a>
        </div>
        
        <div class="card">
            <h3><i class="fas fa-robot"></i> AI –ï–∫—Å–ø–µ—Ä—Ç</h3>
            <p>–®—Ç—É—á–Ω–∏–π —ñ–Ω—Ç–µ–ª–µ–∫—Ç –¥–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π –Ω–∞ –±—É–¥—å-—è–∫—ñ –±—É—Ö–≥–∞–ª—Ç–µ—Ä—Å—å–∫—ñ –ø–∏—Ç–∞–Ω–Ω—è. –¶—ñ–ª–æ–¥–æ–±–æ–≤–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∞.</p>
            <a href="/ai-chat" class="btn"><i class="fas fa-comments"></i> –ó–∞–ø–∏—Ç–∞—Ç–∏ AI</a>
        </div>
    </div>
    
    <div class="card">
        <h3><i class="fas fa-chart-line"></i> –®–≤–∏–¥–∫–∏–π –æ–≥–ª—è–¥ —Å–∏—Å—Ç–µ–º–∏</h3>
        <div class="feature-grid">
            <div class="feature">
                <h4><i class="fas fa-shield-alt"></i> –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ –±–µ–∑–ø–µ–∫–∞</h4>
                <p>–®–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö, —Ä–µ–≥—É–ª—è—Ä–Ω—ñ –±–µ–∫–∞–ø–∏, –∑–∞—Ö–∏—Å—Ç –≤—ñ–¥ –≤—Ç—Ä–∞—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó</p>
            </div>
            <div class="feature">
                <h4><i class="fas fa-bolt"></i> –ú–∏—Ç—Ç—î–≤—ñ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫–∏</h4>
                <p>–û–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω—ñ –∞–ª–≥–æ—Ä–∏—Ç–º–∏ –¥–ª—è —à–≤–∏–¥–∫–∏—Ö —Ç–∞ —Ç–æ—á–Ω–∏—Ö —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–∏—Ö —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—ñ–≤</p>
            </div>
            <div class="feature">
                <h4><i class="fas fa-mobile-alt"></i> –ê–¥–∞–ø—Ç–∏–≤–Ω–∏–π –¥–∏–∑–∞–π–Ω</h4>
                <p>–Ü–¥–µ–∞–ª—å–Ω–∞ —Ä–æ–±–æ—Ç–∞ –Ω–∞ –∫–æ–º–ø'—é—Ç–µ—Ä–∞—Ö, –ø–ª–∞–Ω—à–µ—Ç–∞—Ö —Ç–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö –ø—Ä–∏—Å—Ç—Ä–æ—è—Ö</p>
            </div>
            <div class="feature">
                <h4><i class="fas fa-cloud"></i> –•–º–∞—Ä–Ω–µ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è</h4>
                <p>–î–æ—Å—Ç—É–ø –¥–æ –≤–∞—à–∏—Ö –¥–∞–Ω–∏—Ö –∑ –±—É–¥—å-—è–∫–æ–≥–æ –ø—Ä–∏—Å—Ç—Ä–æ—é –≤ –±—É–¥—å-—è–∫–∏–π —á–∞—Å</p>
            </div>
        </div>
    </div>
    """
    return HTMLResponse(content=get_base_html("JDG Accounting Pro - –ì–æ–ª–æ–≤–Ω–∞", content))

@app.get("/transactions", response_class=HTMLResponse)
def transactions_page():
    content = """
    <div class="card">
        <h3><i class="fas fa-plus-circle"></i> –î–æ–¥–∞—Ç–∏ –Ω–æ–≤—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é</h3>
        <form id="transactionForm">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="form-group">
                    <label for="date"><i class="fas fa-calendar"></i> –î–∞—Ç–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó</label>
                    <input type="date" id="date" name="date" required value="{{today}}">
                </div>
                <div class="form-group">
                    <label for="type"><i class="fas fa-exchange-alt"></i> –¢–∏–ø –æ–ø–µ—Ä–∞—Ü—ñ—ó</label>
                    <select id="type" name="type" required>
                        <option value="income">üìà –î–æ—Ö—ñ–¥</option>
                        <option value="expense">üìâ –í–∏—Ç—Ä–∞—Ç–∞</option>
                    </select>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="form-group">
                    <label for="category"><i class="fas fa-tag"></i> –ö–∞—Ç–µ–≥–æ—Ä—ñ—è</label>
                    <select id="category" name="category">
                        <option value="services">üíº –ü–æ—Å–ª—É–≥–∏</option>
                        <option value="goods">üì¶ –¢–æ–≤–∞—Ä–∏</option>
                        <option value="rent">üè† –û—Ä–µ–Ω–¥–∞</option>
                        <option value="utilities">‚ö° –ö–æ–º—É–Ω–∞–ª—å–Ω—ñ</option>
                        <option value="salary">üë• –ó–∞—Ä–ø–ª–∞—Ç–∞</option>
                        <option value="transport">üöö –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</option>
                        <option value="other">üìù –Ü–Ω—à–µ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="amount"><i class="fas fa-money-bill-wave"></i> –°—É–º–∞ (PLN)</label>
                    <input type="number" id="amount" name="amount" step="0.01" min="0.01" placeholder="0.00" required>
                </div>
            </div>
            
            <div class="form-group">
                <label for="description"><i class="fas fa-file-alt"></i> –û–ø–∏—Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó</label>
                <textarea id="description" name="description" rows="3" placeholder="–î–µ—Ç–∞–ª—å–Ω–∏–π –æ–ø–∏—Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó..."></textarea>
            </div>
            
            <button type="submit" class="btn btn-success" style="width: 100%;">
                <i class="fas fa-save"></i> –ó–±–µ—Ä–µ–≥—Ç–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é
            </button>
        </form>
    </div>
    
    <div class="card">
        <h3><i class="fas fa-history"></i> –Ü—Å—Ç–æ—Ä—ñ—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π</h3>
        <div style="display: flex; gap: 15px; margin-bottom: 20px;">
            <button onclick="loadTransactions()" class="btn"><i class="fas fa-sync-alt"></i> –û–Ω–æ–≤–∏—Ç–∏</button>
            <button onclick="clearAllTransactions()" class="btn btn-danger"><i class="fas fa-trash"></i> –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ</button>
        </div>
        <div id="transactionsList">
            <div class="loading"><i class="fas fa-spinner fa-spin"></i> –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π...</div>
        </div>
    </div>
    
    <script>
        // –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ —Å—å–æ–≥–æ–¥–Ω—ñ—à–Ω—é –¥–∞—Ç—É –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
        document.getElementById('date').value = new Date().toISOString().split('T')[0];
        
        // –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        document.addEventListener('DOMContentLoaded', function() {
            loadTransactions();
        });

        document.getElementById('transactionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const transaction = {
                date: formData.get('date'),
                type: formData.get('type'),
                category: formData.get('category'),
                amount: parseFloat(formData.get('amount')),
                description: formData.get('description')
            };
            
            try {
                showLoading('transactionsList', '–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó...');
                const response = await fetch('/api/transactions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(transaction)
                });
                
                if (response.ok) {
                    showSuccess('transactionsList', '–¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é —É—Å–ø—ñ—à–Ω–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ!');
                    setTimeout(() => {
                        this.reset();
                        document.getElementById('date').value = new Date().toISOString().split('T')[0];
                        loadTransactions();
                    }, 1500);
                } else {
                    showError('transactionsList', '–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó');
                }
            } catch (error) {
                showError('transactionsList', '–ü–æ–º–∏–ª–∫–∞: ' + error);
            }
        });
        
        async function loadTransactions() {
            try {
                showLoading('transactionsList', '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π...');
                const response = await fetch('/api/transactions');
                const transactions = await response.json();
                
                const list = document.getElementById('transactionsList');
                if (transactions.length === 0) {
                    list.innerHTML = '<div class="loading"><i class="fas fa-inbox"></i> –ù–µ–º–∞—î —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π. –î–æ–¥–∞–π—Ç–µ –ø–µ—Ä—à—É!</div>';
                    return;
                }
                
                let totalIncome = 0;
                let totalExpenses = 0;
                
                list.innerHTML = transactions.map(t => {
                    if (t.type === 'income') totalIncome += t.amount;
                    else totalExpenses += t.amount;
                    
                    return `
                        <div class="transaction-item ${t.type === 'income' ? 'transaction-income' : 'transaction-expense'}">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 1.1em;">${t.description}</div>
                                <div style="color: #718096; font-size: 0.9em; margin-top: 5px;">
                                    <i class="fas fa-calendar"></i> ${formatDate(t.date)} ‚Ä¢ 
                                    <i class="fas fa-tag"></i> ${t.category} ‚Ä¢ 
                                    ${t.type === 'income' ? '<i class="fas fa-arrow-up success"></i> –î–æ—Ö—ñ–¥' : '<i class="fas fa-arrow-down error"></i> –í–∏—Ç—Ä–∞—Ç–∞'}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 700; font-size: 1.2em; color: ${t.type === 'income' ? '#48bb78' : '#f56565'}">
                                    ${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}
                                </div>
                                <button onclick="deleteTransaction('${t.id}')" class="btn btn-danger" style="padding: 5px 12px; margin-top: 8px; font-size: 0.9em;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // –î–æ–¥–∞—Ç–∏ –ø—ñ–¥—Å—É–º–æ–∫
                const profit = totalIncome - totalExpenses;
                list.innerHTML += `
                    <div style="margin-top: 25px; padding: 20px; background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%); border-radius: 15px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; text-align: center;">
                            <div>
                                <div style="font-size: 0.9em; color: #718096;">–ó–∞–≥–∞–ª—å–Ω–∏–π –¥–æ—Ö—ñ–¥</div>
                                <div style="font-size: 1.3em; font-weight: 700; color: #48bb78;">+${formatCurrency(totalIncome)}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.9em; color: #718096;">–ó–∞–≥–∞–ª—å–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏</div>
                                <div style="font-size: 1.3em; font-weight: 700; color: #f56565;">-${formatCurrency(totalExpenses)}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.9em; color: #718096;">–ß–∏—Å—Ç–∏–π –ø—Ä–∏–±—É—Ç–æ–∫</div>
                                <div style="font-size: 1.3em; font-weight: 700; color: ${profit >= 0 ? '#48bb78' : '#f56565'}">${profit >= 0 ? '+' : ''}${formatCurrency(profit)}</div>
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                showError('transactionsList', '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ' + error);
            }
        }
        
        async function deleteTransaction(id) {
            if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é?')) {
                try {
                    showLoading('transactionsList', '–í–∏–¥–∞–ª–µ–Ω–Ω—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó...');
                    await fetch(`/api/transactions/${id}`, { method: 'DELETE' });
                    loadTransactions();
                } catch (error) {
                    showError('transactionsList', '–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è');
                }
            }
        }
        
        async function clearAllTransactions() {
            if (confirm('–¶—è –¥—ñ—è –≤–∏–¥–∞–ª–∏—Ç—å –í–°–Ü —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó. –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏?')) {
                try {
                    showLoading('transactionsList', '–û—á–∏—â–µ–Ω–Ω—è –≤—Å—ñ—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π...');
                    const response = await fetch('/api/transactions');
                    const transactions = await response.json();
                    
                    // –í–∏–¥–∞–ª–∏—Ç–∏ –∫–æ–∂–Ω—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é
                    for (const transaction of transactions) {
                        await fetch(`/api/transactions/${transaction.id}`, { method: 'DELETE' });
                    }
                    
                    loadTransactions();
                } catch (error) {
                    showError('transactionsList', '–ü–æ–º–∏–ª–∫–∞ –æ—á–∏—â–µ–Ω–Ω—è');
                }
            }
        }
    </script>
    """
    return HTMLResponse(content=get_base_html("–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è–º–∏ - JDG Accounting Pro", content))

@app.get("/tax-calculator", response_class=HTMLResponse)
def tax_calculator_page():
    content = """
    <div class="card">
        <h3><i class="fas fa-calculator"></i> –†–æ–∑—à–∏—Ä–µ–Ω–∏–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø–æ–¥–∞—Ç–∫—ñ–≤</h3>
        <p style="color: #718096; margin-bottom: 25px;">–¢–æ—á–Ω—ñ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫–∏ –ø–æ–¥–∞—Ç–∫—ñ–≤ –¥–ª—è –ø–æ–ª—å—Å—å–∫–∏—Ö –ø—ñ–¥–ø—Ä–∏—î–º—Ü—ñ–≤ (JDG)</p>
        
        <form id="taxForm">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                <div class="form-group">
                    <label for="year"><i class="fas fa-calendar-alt"></i> –ü–æ–¥–∞—Ç–∫–æ–≤–∏–π —Ä—ñ–∫</label>
                    <input type="number" id="year" name="year" value="2024" min="2020" max="2030" required>
                </div>
                <div class="form-group">
                    <label for="tax_mode"><i class="fas fa-balance-scale"></i> –°–∏—Å—Ç–µ–º–∞ –æ–ø–æ–¥–∞—Ç–∫—É–≤–∞–Ω–Ω—è</label>
                    <select id="tax_mode" name="tax_mode" required>
                        <option value="progressive">üìà –ü—Ä–æ–≥—Ä–µ—Å–∏–≤–Ω–∞ (12%/32%)</option>
                        <option value="flat19">üìä –õ—ñ–Ω—ñ–π–Ω–∞ 19%</option>
                        <option value="lump_sum">üìã –†–∏—Ü–∞≈Ç—Ç 10%</option>
                    </select>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                <div class="form-group">
                    <label for="gross_income"><i class="fas fa-money-bill-wave"></i> –í–∞–ª–æ–≤–∏–π –¥–æ—Ö—ñ–¥ (PLN)</label>
                    <input type="number" id="gross_income" name="gross_income" step="0.01" min="0" placeholder="100000.00" required>
                </div>
                <div class="form-group">
                    <label for="expenses"><i class="fas fa-receipt"></i> –í–∏—Ç—Ä–∞—Ç–∏ (PLN)</label>
                    <input type="number" id="expenses" name="expenses" step="0.01" min="0" value="0" placeholder="20000.00">
                </div>
            </div>
            
            <button type="submit" class="btn" style="width: 100%; padding: 16px;">
                <i class="fas fa-calculator"></i> –†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ –ø–æ–¥–∞—Ç–∫–æ–≤–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
            </button>
        </form>
    </div>
    
    <div id="taxResult"></div>
    
    <script>
        document.getElementById('taxForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const taxData = {
                year: parseInt(formData.get('year')),
                gross_income: parseFloat(formData.get('gross_income')),
                expenses: parseFloat(formData.get('expenses')),
                tax_mode: formData.get('tax_mode')
            };
            
            try {
                document.getElementById('taxResult').innerHTML = '<div class="loading"><i class="fas fa-calculator fa-spin"></i> –í–∏–∫–æ–Ω—É—î–º–æ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫–∏...</div>';
                
                const response = await fetch('/api/calculate_taxes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(taxData)
                });
                
                const result = await response.json();
                
                document.getElementById('taxResult').innerHTML = `
                    <div class="result-card">
                        <h3><i class="fas fa-chart-pie"></i> –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –ø–æ–¥–∞—Ç–∫–æ–≤–æ–≥–æ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É</h3>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin: 25px 0;">
                            <div>
                                <h4 style="color: #4a5568; margin-bottom: 15px;"><i class="fas fa-chart-line"></i> –§—ñ–Ω–∞–Ω—Å–æ–≤—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏</h4>
                                <div style="background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%); padding: 20px; border-radius: 12px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                        <span>–í–∞–ª–æ–≤–∏–π –¥–æ—Ö—ñ–¥:</span>
                                        <strong>${formatCurrency(result.gross_income)}</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                        <span>–í—Ä–∞—Ö–æ–≤–∞–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏:</span>
                                        <strong style="color: #f56565;">-${formatCurrency(result.expenses)}</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding-top: 12px; border-top: 1px solid #e2e8f0;">
                                        <span>–î–æ—Ö—ñ–¥ –¥–æ –æ–ø–æ–¥–∞—Ç–∫—É–≤–∞–Ω–Ω—è:</span>
                                        <strong style="color: #667eea;">${formatCurrency(result.taxable_income)}</strong>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <h4 style="color: #4a5568; margin-bottom: 15px;"><i class="fas fa-file-invoice-dollar"></i> –ü–æ–¥–∞—Ç–∫–æ–≤—ñ –∑–æ–±–æ–≤'—è–∑–∞–Ω–Ω—è</h4>
                                <div style="background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%); padding: 20px; border-radius: 12px;">
                                    <div style="text-align: center; margin-bottom: 15px;">
                                        <div style="font-size: 0.9em; color: #718096;">–ü–æ–¥–∞—Ç–æ–∫ –¥–æ —Å–ø–ª–∞—Ç–∏</div>
                                        <div style="font-size: 2em; font-weight: 700; color: #